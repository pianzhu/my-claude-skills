---
name: problem-solution-dialogue
description: Use when 需要讨论方案权衡/架构选型/需求澄清，且目标/约束/成功标准不清或存在多解权衡时。
---

# 问题-方案对话（权衡/选型/澄清）

## 概览

- 目标：输出 2–3 个可验证候选方案，让用户做选择；选定后做事前验尸并给终稿
- 边界：只讨论与形成方案集；除非用户明确要求，不做实现改动
- 适用：目标/约束/成功标准不清，或存在多解权衡（含根因不明需先给验证路径）
- 不适用：明确规格要求直接实现；或单点事实查询/知识问答

## 输出约束（必须遵守）

- 候选阶段（第 3 步）：只输出“对齐信息 3 行” + 2–3 个候选方案；不输出流程图或中间推理产物
- 定稿阶段（第 4 步）：只输出两块内容：1) D2“决策流程图”（将同目录 `decision-flow.d2` 原样放入代码块）；2) 2–3 个可选方案（标注已选/推荐）
- 仅在用户明确要求时展开：推理过程、为什么、验证路径、事前验尸细节
- 文件引用规范：默认不查看；仅当需要改动文件引用或运行校验脚本时再阅读 [references/REFERENCE.md](references/REFERENCE.md)

## 流程

### 理解问题（第 1 步：对齐上下文，不讨论方案）

**必需参考：** [context-clarifier.md](context-clarifier.md)

- 本步只产出“对齐信息 3 行”（例：把诉求收敛成可验收标准/硬约束/最大不确定性+最小验证）
- 交互规则：每轮只问 1 个问题（优先选择题）；不讨论方案/选型/结论（例：只澄清“成功怎么算”）
- 阶段门：3 行未补齐不进入后续步骤；若用户明确要求可先给“基于假设”的临时方案，但必须同时标注假设与待验证项

### 假设与边界分析（第 2 步：内部推理，严禁输出）

必须在脑中完成以下检查，但绝不向用户展示：

- **假设生成**：列 2–3 个假设（含 1 个低概率高风险）；给最可能假设的最小验证动作
- **边界识别**：标注 1–2 个关键杠杆点与副作用通道；用于约束方案边界
- **护栏**：低概率高风险假设未证伪前不淘汰；前提被否定则回退更新

### 候选方案（第 3 步：输出 2–3 个，让用户选）

输出结构：先输出 3 行对齐信息，再输出候选方案；不输出流程图。

对齐信息（3 行，必须原样保留结构）：
- 成功标准：
- 硬约束：
- 最大不确定性：？ 最小验证：

每个方案字段（最少集）：
- 核心思路；适用/不适用；收益/风险；第一步；关键假设 + 最小验证 + 护栏

必须给出你的推荐，并说明推荐依赖的关键假设是什么。

阶段门：用户未选方案前必须停止并等待选择。

### 事前验尸 + 回退策略（第 4 步：关键步骤）

默认进入；仅当用户明确要求“跳过事前验尸/只要快速结论”时跳过。
- 假设 3–6 个月后失败：列 3–5 个失败模式（漏洞）
- 每个漏洞：触发条件 / 早期信号 / 缓解或降级

回退与收敛规则：见“红旗信号”（命中即停止，并按红旗级别执行：阻断红旗必须回退；可继续红旗由用户选择回退或接受风险继续）。

终稿：收敛后按“输出约束”输出，并让用户选择下一步（第 5 步 / 回到第 3 步 / 到此结束）。

D2“决策流程图”：见同目录 `decision-flow.d2`（输出时原样使用该文件内容）。

### 生成可执行计划（第 5 步：文件级）

**必需子技能：** `planning-with-files`

仅当用户明确要求“生成可执行计划/拆分任务/输出任务清单”时进入，并直接调用 `planning-with-files` 产出文件级计划。

## 红旗信号（命中即停止并分流）

- 命中条件：阶段门违规/前提被否定/验证不可执行/高风险未受控（例：最小验证写不出来）
- 触发动作：立刻停止；只输出 `RF-x` + 触发事实（例：硬约束与当前方案冲突）
- 阻断红旗：必须回退到 `RF-x -> 1/2/3` 指定步骤；回退后只做 1 件事（问 1 题或给 1 个最小验证）然后停（例：回退补齐成功标准）
- 可继续红旗：用户二选一：`回退补齐` / `接受风险继续`；继续前必须确认“风险接受声明：风险/范围/触发信号/护栏或降级/回滚点”（例：接受“先改再看”，但要开关与回滚点）
- 查表：仅命中或用户追问时打开 [references/red-flags.md](references/red-flags.md)（例：未命中不要展开）
- 循环控制：回退 >=2 次仍不收敛 → 提示“重新建模/架构复盘” → 回到第 1 步（例：反复回退仍无法形成可选方案）

## 关键原则

- 一次只解决一个不确定性：先最小验证，再谈方案与计划
- 阶段门优先：用户未选方案前，必须停在第 3 步
- 低概率高风险不提前淘汰：用“早期信号 + 护栏”管理
- 默认克制输出：不写中间推理；用户要才展开
